(function(a){a.fn.bdmap=function(b){a.fn.bdmap.defaults={detal:{sign_name:"TXjiang",contact_tel:18624443174,address:"天安门"},latitude:39.915,longitude:116.404,fnOpen:null,fnClose:null};var c=a.extend({},a.fn.bdmap.defaults,b);return this.each(function(){var r=a(this),e=c.detal,v=c.latitude,n=c.longitude,t=c.fnClose,d=c.fnOpen,w=r.hasClass("bigOpen"),f=null,p=null,u=null,s=null;var h,x,q,i;var o=a('<div id="BDMap" class="BDMap"></div>');r.append(o);r.append(a('<div id="transit_result"></div>'));r.append(a('<div class="tit"><p><a href="javascript:void(0)"><span class="css_sprite01"></span>'+e.address+"</a></p></div>"));r.append(a('<p class="map-close-btn">退出</p>'));if(r.length>0){var m=r.height()}if(w){r.find(".map-close-btn").css("display","block")}if(a("#transit_result").length>0&&a("#transit_result").html()!=""){a(".transitBtn").removeClass("hide")}var k=function(){if(r.size()>0){x=new BMap.Map(o.attr("id")),q=new BMap.Point(n,v),i=new BMap.Marker(q);x.enableScrollWheelZoom();x.enableInertialDragging();x.centerAndZoom(q,15);x.addOverlay(i);y();i.addEventListener("click",function(z){y()});x.addEventListener("click",function(z){return false});x.addEventListener("zoomend",function(A){var z=x.getZoom();x.centerAndZoom(q,z)})}},y=function(){l(i,e)},l=function(B,A){var D=a('<div class="infoWindow"></div>');if(typeof(A.contact_tel)!="undefined"){D.append('<p class="tel"><a href="tel:'+A.contact_tel+'">'+A.contact_tel+"</a></p>")}D.append('<p class="address">'+A.address+"</p>");D.append('<div class="window_btn"><span class="open_navigate open_bus" onclick="open_navigate(this)">公交</span><span class="open_navigate open_car" onclick="open_navigate(this)">自驾</span><span class="State"></span></div>');var z={width:0,height:0,title:" "};var C=new BMap.InfoWindow(D[0],z);B.openInfoWindow(C,x.getCenter())};open_navigate=function(z){a(z).hasClass("open_bus")?f="bus":f="car";navigate();a(".infoWindow").find("span.State").html("正在定位您的位置！")},navigate=function(){if(window.navigator.geolocation){window.navigator.geolocation.getCurrentPosition(handleSuccess,handleError,{timeout:10000})}else{alert("sorry！您的设备不支持定位功能")}},handleError=function(z){var A;switch(z.code){case z.TIMEOUT:A="获取超时!请稍后重试!";break;case z.POSITION_UNAVAILABLE:A="无法获取当前位置!";break;case z.PERMISSION_DENIED:A="您已拒绝共享地理位置!";break;case z.UNKNOWN_ERROR:A="无法获取当前位置!";break}if(a(".infoWindow").find("span.State").length>0){a(".infoWindow").find("span.State").html(A)}else{alert(A)}},handleSuccess=function(z){var B=z.coords;var C=B.latitude;var A=B.longitude;s=new BMap.Point(A,C);a(".infoWindow").find("span.State").html("获取信息成功，正在加载中！");if(f=="bus"){bus_transit()}else{self_transit()}if(!w){o.parent().addClass("open")}else{o.parent().addClass("map-open")}};a(".map-close-btn").on("click",function(){r.removeClass("map-open open");if(t){t()}});bus_transit=function(){if(p){p.clearResults()}if(u){u.clearResults()}if(!s){alert("抱歉：定位失败！");return}a(".fn-audio").hide();if(typeof(loadingPageShow)=="function"){loadingPageShow()}a(".infoWindow").find("span.State").html("正在绘制出导航路线");var z=a("#transit_result")||a('<div id="transit_result"></div>');z.appendTo(r);p=new BMap.TransitRoute(x,{renderOptions:{map:x,panel:"transit_result",autoViewport:true},onSearchComplete:searchComplete});p.search(s,q)},self_transit=function(){if(p){p.clearResults()}if(u){u.clearResults()}if(!s){alert("抱歉：定位失败！");return}a(".fn-audio").hide();if(typeof(loadingPageShow)=="function"){loadingPageShow()}a(".infoWindow").find("span.State").html("正在绘制出导航路线");var z=a("#transit_result")||a('<div id="transit_result"></div>');z.appendTo(r);u=new BMap.DrivingRoute(x,{renderOptions:{map:x,panel:z.attr("id"),autoViewport:true},onSearchComplete:searchComplete});u.search(s,q)},searchComplete=function(z){if(z.getNumPlans()==0){alert("非常抱歉,未搜索到可用路线");x.reset();x.centerAndZoom(q,15);y();a("#transit_result").removeClass("open").hide();a(".transitBtn").hide()}else{a("#transit_result").addClass("open");a(".infoWindow").find("span.State").html("");if(!a(".transitBtn").length>0){a("#transit_result").after(a('<p class="transitBtn close" onclick="transit_result_close()"><a href="javascript:void(0)">关闭</a></p>'));a("#transit_result").after(a('<p class="transitBtn bus" onclick="bus_transit()"><a href="javascript:void(0)">公交</a></p>'));a("#transit_result").after(a('<p class="transitBtn car" onclick="self_transit()"><a href="javascript:void(0)">自驾</a></p>'))}r.find(".close_map").show();a("#transit_result").addClass("open");a(".transitBtn").show();a("#transit_result").on("touchstart",B);a("#transit_result").on("touchmove",A);function B(C){var D;D=window.event.touches[0].pageY;h=D}function A(E){E.stopPropagation();E.preventDefault();var C;C=window.event.touches[0].pageY;var D=a(this).scrollTop();a(this).scrollTop(D+h-C);h=C}}if(typeof(loadingPageHide)=="function"){loadingPageHide()}if(!w){r.css({position:"fixed",top:"0",left:"0",height:"100%",})}if(a("#transit_result").hasClass("open")){a(".close").find("a").html("关闭")}else{a(".close").find("a").html("打开")}};transit_result_close=function(){if(a("#transit_result").hasClass("open")){a("#transit_result").removeClass("open");a(".close").find("a").html("打开")}else{a("#transit_result").addClass("open");a(".close").find("a").html("关闭")}};window.mapInit=k;function j(){if(a(".BDS").length<=0){var C=document.createElement("script");C.src="http://api.map.baidu.com/api?v=1.4&callback=mapInit";C.className+="BDS";document.head.appendChild(C)}else{k()}if(a(".BDC").length<=0){var A=document.createElement("style");A.type="text/css";A.className+="BDC";var D=phoneScale=1;var z=a(window).height();var B=".bdmap.open,.bdmap.map-open {height:100%;width:100%;background:#fff;}.bdmap img {max-width:initial!important;}.bdmap .tit { position:absolute; left:0; bottom:0; height:70px; width:100%; overflow: hidden; background:rgba(0,0,0,0.5); }.bdmap .tit p { margin-right:100px; }.bdmap .tit p a { position:relative; display:block; font-size:24px; color:#fff; height:70px; line-height:70px; padding-left:70px; }.bdmap .tit p a span { position:absolute; left:15px; top:15px; display:inline-block; width:40px;height:40px; }.bdmap .tit .close_map { display:none; position: absolute; bottom: 15px; right: 20px; width: 40px; height: 40px; margin-right:0; cursor:pointer; background-position: -100px -73px; }.bdmap .map-close-btn{position:absolute;top:10px;left:10px;display:none;width:80px;box-shadow:0 0 2px rgba(0,0,0,0.6) inset, 0 0 2px rgba(0,0,0,0.6);height:80px;border-radius:80%;color:#fff;background:rgba(230,45,36,0.8);text-align:center;line-height:80px;font-size:26px; font-weight:bold;cursor:pointer;}.bdmap.open .map-close-btn{display:block;}.bdmap.mamap-openmap-close-btn{display:block;}#BDMap {transform:scale("+D+");-webkit-transform:scale("+D+");}#BDMap {width:100%;height:100%;}#BDMap img{width:auto;height:auto;}.bdmap.open .transitBtn{display:block;}.bdmap.map-open .transitBtn{display:block;}.transitBtn {display:none;position:absolute;z-index:3000;}.transitBtn a{display:block;width:80px;box-shadow:0 0 2px rgba(0,0,0,0.6) inset, 0 0 2px rgba(0,0,0,0.6);height:80px;border-radius:80%;color:#fff;background:rgba(230,45,36,0.8);text-align:center;line-height:80px;font-size:24px; font-weight:bold}.transitBtn.close {top:10px;right:10px;}.transitBtn.bus {top:10px;right:110px;}.transitBtn.car {top:110px;right:10px;}.transitBtn.bus a{background:rgba(28,237,235,0.8);}.transitBtn.car a{background:rgba(89,237,37,0.8);}#transit_result{display:none;position:absolute;top:0;left:0;width:100%;height:100%;z-index:1000;overflow-y:scroll;}#transit_result.open{display:block;}#transit_result h1{font-size:26px!important;}#transit_result div[onclick^='Instance']{background:none!important;}#transit_result span{display:inline-block;font-size:20px;padding:0 5px;}#transit_result table {font-size:20px!important;}#transit_result table td{padding:5px 10px!important;line-height:150%!important;}.infoWindow p{margin-bottom:10px;}.infoWindow .window_btn .open_navigate{display:inline-block;padding:2px 6px; margin-right:10px;border:1px solid #ccc;border-radius:6px;text-align:center;cursor:pointer;}.anchorBL{display:none!important;}";A.innerHTML=B;document.head.appendChild(A)}}function g(){var z=navigator.userAgent;var C=new Array("Android","iPhone","SymbianOS","Windows Phone","iPad","iPod");var A=true;for(var B=0;B<C.length;B++){if(z.indexOf(C[B])>0){A=false;break}}return A}j()})}})(Zepto);