(function(a){a.fn.upload=function(b){a.fn.upload.defaults={url:"",numLimit:5,formCls:"upload-form"};var c=a.extend({},a.fn.upload.defaults,b);var d=function(e){e=a.isArray(e)?e.join(""):(e||"");return{store:e,_:function(){var f=this;a.each(arguments,function(g,h){f.store+=h});return this},toString:function(){return this.store}}};return this.each(function(){var m=a(this),i=m.find(".btn-upload"),j=null;var e=function(){j=m.find("input");i.click(function(n){n.preventDefault();if(a(this).hasClass("none")){return}j.trigger("click")});j.on("change",function(n){l()});m.on("click",".img-preview",function(n){n.preventDefault();if(a(n.target).hasClass("close")){return}h(a(this).find("img").attr("src"))}).on("click",".close",function(n){n.preventDefault();a(this).closest("a").remove();i.removeClass("none")})},l=function(){var p=j.get(0),r=p.files.length,o="img-"+new Date().getTime();if(a(".img-preview").length>=c.numLimit-1){i.addClass("none")}if(p.files&&p.files[0]){var n=new FileReader(),q=d();q._('<a href="#" id="'+o+'" class="img-preview loading" data-collect="true" data-collect-flag="news-baoliao-preview-btn" data-collect-desc="预览图片按钮">')._('<span class="lc"><i class="uploading"></i></span>')._('<i class="close"  data-collect="true" data-collect-flag="news-baoliao-remove-img-btn" data-collect-desc="删除上传的图片按钮" data-stoppropagation="true"></i>')._('<span class="ic"><img /></span>')._("</a>");i.before(q.toString());n.onload=function(s){if(s.target.result&&s.target.result.indexOf("image/")!==-1){a("#"+o).find("img").attr("src",s.target.result)}};n.readAsDataURL(p.files[0])}k(o)},k=function(n){var p=new FormData(),o=j.get(0),q=o.files.length;if(q==0){return}p.append("file",o.files[0]);p.append("serviceName","clueImg");f(n,p)},f=function(n,p){var q=this,r=new XMLHttpRequest(),s=a("#"+n),o=s.find("img");r.addEventListener("load",function(t){if(t.target&&t.target.responseText){var u=null;try{u=a.parseJSON(t.target.responseText)}catch(v){}if(!u||u.code!=0){alert("上传图片失败");return}if(!o.attr("src")){o.attr("src",u.filePath)}s.attr("data-url",u.filePath).removeClass("loading")}},false);if(p==0){return}r.addEventListener("error",function(){a("#"+n).removeClass("loading");alert("上传出错")},false);r.addEventListener("abort",function(){a("#"+n).removeClass("loading");alert("上传已取消")},false);r.open("POST",c.url);r.send(p)},h=function(r){var p=d(),o=a(".preview-box"),n=a(window).width(),q=a(window).height();if(o.length==0){p._('<div class="preview-box">')._('<img class="none" />')._("</div>");o=a(p.toString())}else{o.show()}imgReady(r,function(){var s=n-20,t=q-20,v=s/t,u=this.width/this.height;if(this.width>s||this.height>t){if(v<=u){t=s*(this.height/this.width)}else{s=t*(this.width/this.height)}}else{s=this.width;t=this.height}o.find("img").attr("src",r).css({width:s,height:t,"margin-left":(n-s)/2,"margin-top":(q-t)/2}).removeClass("none")});a("html").addClass("noscroll");a("body").append(o).delegate(".preview-box","click",function(s){o.hide();a("html").removeClass("noscroll")})},g=function(){var o=m.find("."+c.formCls);if(o.length>0){return}var n=d();n._('<form class="'+c.formCls+'" enctype="multipart/form-data" method="post">')._('<input type="file" accept="image/*" capture="camera">')._("</form>");o=a(n.toString());m.append(o)};g();e()})}})(Zepto);