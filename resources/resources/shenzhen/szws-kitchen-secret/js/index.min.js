$(function(){var a={showPage:function(b,d,e){var c=$(".page");c.addClass("none");c.each(function(g,h){var f=$(h);if(f.attr("id")==b){f.removeClass("none");a.currentPage=f;if(d){d(f)}return false}})},hashchange:(function(){$(window).bind("hashchange",function(){var b=window.location.hash.slice(1);if(b){a.page[b]()}else{b="firstPage";a.page[b]()}if(a[b].goIntoFn){a[b].goIntoFn()}});return{}})(),loadData:function(g){var f=$.extend({url:"",type:"get",async:false,dataType:"jsonp",showload:true},g);if(f.showload){W.showLoading()}var c=0;var e="";var b=null;for(var d in g){c++;if(c==2){e=d;b=g[d];break}}$.ajax({type:f.type,data:g.data,async:f.async,url:f.url,dataType:f.dataType,jsonpCallback:e,success:function(h){W.hideLoading();b(h)},error:function(){if(g.error){g.error()}W.hideLoading()}})},loadImg:function(c){if(!this.images){this.images=[]}if(c&&!(c instanceof Array)){c.isLoad=false;this.images.push(c)}else{if((c instanceof Array)){for(var e=0;e<c.length;e++){c[e].isLoad=false;this.images.push(c[e])}}}for(var d=0;d<this.images.length;d++){var f=this;if(!this.images[d].isLoad){var b=new Image();b.src=this.images[d].src;this.images[d].isLoad=true;b.onload=function(){}}}},showWin:function(c){var b=$.extend({html:"",beforeOpenFn:null,afterOpenFn:null},c||{});this.winObj=$('<div class="win"><div class="win_model"></div><div class="win_contain"><div class="win_html"></div></div></div>');this.close=function(d){this.winObj.remove();if(d){d()}if(this.closeFn){this.closeFn()}};this.setWidth=function(d){this.winObj.css("width",d)};this.setHeight=function(d){this.winObj.css("height",d)};this.setHtml=function(d){this.winObj.find(".win_html").append(d||b.html)};this.initEvent=function(){var d=this;this.winObj.find(".win_close").unbind("click").click(function(){d.close()})};this.init=function(d){this.setHtml();if(b.beforeOpenFn){b.beforeOpenFn(this.winObj)}$("body").append(this.winObj);this.initEvent();this.winObj.find(".win_contain").addClass("show_slow");if(b.afterOpenFn){b.afterOpenFn(this.winObj,this)}if(d){d()}}},module:function(d,c,b){!a[d]&&(a[d]=new c());if(b){$(function(){b()})}},page:{firstPage:function(b){window.location.hash="firstPage";$(".footer").show();$(".bottom_tip").show();a.showPage("firstPage",function(){if(b){b()}})},starPage:function(b){window.location.hash="starPage";$(".footer").hide();a.showPage("starPage",function(){if(b){b()}})}}};a.module("comment",function(){var b={ruleHtml:function(){var c=simpleTpl();c._('<section class="modal" id="rule-dialog">')._('<div class="dialog rule-dialog">')._('<a href="#" class="btn-close" data-collect="true" data-collect-flag="dn-ruledialog-closebtn" data-collect-desc="规则弹层-关闭按钮"></a>')._("<h2></h2>")._('<div class="content border">')._('<div class="rule-con">')._("</div>")._("</div>")._('<p class="dialog-copyright">页面由深圳卫视提供</p>')._("</div>")._("</section>");$("body").append(c.toString())},ruleBtn:function(){$(".top_my_rule").click(function(){b.ruleHtml();a.loadData({url:domain_url+"api/common/rule",commonApiRuleHandler:function(c){if(c.code==0){$(".rule-con").html(c.rule)}}})});$("body").delegate(".btn-close","click",function(c){$("#rule-dialog").remove()})}};this.pageH=function(){var c=$(window).height();$(".page").css("height",c)};this.initParam=function(){this.top_down_no=$(".top_down_no");this.top_subscribe=$(".top_subscribe");this.top_my_score=$(".top_my_score");this.c_input=$(".c_input");this.send=$("#send");this.c_input=$(".c_input");this.comments=$(".comments");this.top_canLottery=$(".top_canLottery")};this.initEvent=function(){var c=this;this.eventobj={top_subscribeFn:function(){var d=window.reserveId_t;if(!d){return}shaketv.reserve(yao_tv_id,d,function(e){})},top_my_scoreFn:function(){var d=c.tid;if(!c.tid){d=$.fn.cookie("user_score_tid")}a.loadData({url:domain_url+"api/lottery/integral/rank/self",callbackIntegralRankSelfRoundHandler:function(g){var f=[];f.push('<section class="contain_rank"><img src="./images/close.png" class="win_close" /><section class="pop-points">');f.push('<div class="rank-tips">累积积分前20名可获得益达礼品套装</div>');f.push('<div class="points-head"><i class="head-img"></i> 我的积分:<span class="my_score">0</span>排名 <span class="my_rank"></span></div><div class="points-list">');f.push('<ul class="points-list-ul"></ul></div></section></section>');var e=$(f.join(""));if(g.result){if(g.rk){e.find(".my_rank").text(g.rk)}if(g["in"]){e.find(".my_score").text(g["in"])}if(headimgurl){headimgurl+"/64";e.find(".head-img").css({"background-image":"url('"+headimgurl+"/64')"})}}else{}c.win_rank=new a.showWin({html:e[0].outerHTML,beforeOpenFn:function(h){h.addClass("fadein");h.find(".win_contain").addClass("Transparent")},afterOpenFn:function(){a.loadData({url:domain_url+"api/lottery/integral/rank/top10",callbackIntegralRankTop10RoundHandler:function(k){if(k.result){var h=[];for(var j=0;j<k.top10.length;j++){if(k.top10[j].hi){h.push("<li><i style=\"background-image:url('"+k.top10[j].hi+"')\"></i> "+(k.top10[j]["nn"]?k.top10[j]["nn"]:"匿名")+'</li><li class="right"><span>第'+k.top10[j].rk+"名</span></li>")}else{h.push("<li><i></i> "+(k.top10[j]["nn"]?k.top10[j]["nn"]:"匿名")+'</li><li class="right"><span>第'+k.top10[j].rk+"名</span></li>")}}c.win_rank.winObj.find(".points-list ul").append(h.join(""))}else{}},data:{pu:d}})}});c.win_rank.init()},data:{pu:d,oi:openid},showload:false})},sendFn:function(){var e=c.tid;if(!c.tid){e=$.fn.cookie("user_score_tid")}var d=encodeURIComponent(this.c_input.val());a.loadData({url:domain_url+"api/comments/save",callbackCommentsSave:function(f){if(f.code==0){var g="<div class='c_head_img'><img src='./images/avatar.jpg' class='c_head_img_img' /></div>";if(headimgurl){g="<div class='c_head_img'><img src='"+headimgurl+"/64' class='c_head_img_img' /></div>"}barrage.appendMsg(g+c.c_input.val());c.c_input.val("");c.showTip($("#comments"),"发送成功")}else{if(f.message){alert(f.message);c.c_input.val("")}else{alert("发表评论失败")}}},data:{co:d,op:openid,tid:e,ty:1,nickname:nickname?encodeURIComponent(nickname):"",headimgurl:headimgurl?headimgurl:""}})},top_canLotteryFn:function(){window.location.href="yao.html"}};this.top_subscribe.unbind("click").click($.proxy(this.eventobj.top_subscribeFn,this));this.top_my_score.unbind("click").click($.proxy(this.eventobj.top_my_scoreFn,this));this.send.unbind("click").click($.proxy(this.eventobj.sendFn,this));this.top_canLottery.unbind("click").click($.proxy(this.eventobj.top_canLotteryFn,this));this.down_count=function(j){var i=$.extend({itemObj:"",activity:[],cTime:this.systemTime,eachShowFn:null,canLotteryFn:null,endFn:null},j||{});var h=this;var f=500;var g=i.cTime;window.t_count=0;var d=function(k,o){var n=Math.round((k%60000)/f);n=dateNum(Math.min(Math.floor(n/1000*f),59));var l=dateNum(Math.floor((k%3600000)/60000));var m=dateNum(Math.floor((k%86400000)/3600000));var p=dateNum(Math.floor(k/86400000));i.itemObj.text(o.replace(/%S%/,n).replace(/%M%/,l).replace(/%H%/,m).replace(/%D%/,p))};var e=function(){try{g+=f;if(!i.activity[t_count]){if(window.progressTimeInterval){clearInterval(window.progressTimeInterval)}return}var k=parseInt(timestamp(i.activity[t_count].pd+" "+i.activity[t_count].st));var m=parseInt(timestamp(i.activity[t_count].pd+" "+i.activity[t_count].et));var l=isNaN(k)?0:k-g;var n=isNaN(m)?0:m-g;if(l>0){d(l,"%H%:%M%:%S%");if(i.eachShowFn){i.eachShowFn(i.itemObj.text())}}else{if(n>0){if(i.canLotteryFn){i.canLotteryFn(i.activity[t_count])}}else{t_count++;if(t_count>i.activity.length){if(i.endFn){i.endFn()}if(window.progressTimeInterval){clearInterval(window.progressTimeInterval)}}}}}catch(o){if(window.progressTimeInterval){clearInterval(window.progressTimeInterval)}}};e();window.progressTimeInterval=setInterval(function(){e()},f)}};this.loadData=function(){var f=this;this.load_reserve=function(){a.loadData({url:domain_url+"program/reserve/get",callbackProgramReserveHandler:function(g){if(!g.reserveId){$(".top_subscribe").hide();return}else{$(".top_subscribe").show();window.reserveId_t=g.reserveId;window.shaketv&&shaketv.preReserve(yao_tv_id,g.reserveId,function(h){if(h.errorCode==0){}})}}})};this.load_comment=function(){var h=this;h.maxid=0;window.barrage=this.comments.barrage({fontColor:["6FC3EF","FFF","DE0E4E"]});barrage.start(1);function g(){$.ajax({type:"GET",async:true,url:domain_url+"api/comments/room?temp="+new Date().getTime(),dataType:"jsonp",data:{ps:50,maxid:h.maxid},jsonpCallback:"callbackCommentsRoom",success:function(n){if(n.code==0){h.maxid=n.maxid;var k=n.items||[];for(var l=0,j=k.length;l<j;l++){var m="<div class='c_head_img'><img src='./images/avatar.jpg' class='c_head_img_img' /></div>";if(k[l].hu){m="<div class='c_head_img'><img src='"+k[l].hu+"/64' class='c_head_img_img' /></div>"}if(l<5){$.fn.cookie("default_comment"+l,m+k[l].co,expires_in)}barrage.pushMsg(m+k[l].co)}setTimeout(function(){g()},5000)}else{setTimeout(function(){g()},5000);if(n.message){}}}})}g()};f.activity=[];var d=$(".top_down");var e=$(".top_canLottery");var c=$(".top_end");this.load_activity=function(){$.ajax({type:"GET",async:true,url:domain_url+"api/lottery/round",dataType:"jsonp",jsonpCallback:"callbackLotteryRoundHandler",success:function(g){if(g.result){f.systemTime=g.sctm;f.activity=g.la;f.down_count({itemObj:$(".top_down_no"),activity:f.activity,eachShowFn:function(){d.show();e.hide();c.hide()},canLotteryFn:function(h){d.hide();e.show();c.hide();f.au=h.ud;f.tid=h.ud;$.fn.cookie("user_score_tid",f.tid,{expires:30})},endFn:function(){d.hide();e.hide();c.show()}})}else{d.hide();e.hide();c.show();setTimeout(function(){f.load_activity()},1000);if(g.message){}}},error:function(){c.show();setTimeout(function(){f.load_activity()},1000)}})};this.pushCommentMas=function(){if($.fn.cookie("default_comment0")){window.CACHEMSG.push($.fn.cookie("default_comment0"))}else{window.CACHEMSG.push("<div class='c_head_img'><img src='./images/d1.jpg' class='c_head_img_img' /></div>很好看！！")}if($.fn.cookie("default_comment1")){window.CACHEMSG.push($.fn.cookie("default_comment1"))}else{window.CACHEMSG.push("<div class='c_head_img'><img src='./images/d2.jpg' class='c_head_img_img' /></div>看到就留口水啦")}if($.fn.cookie("default_comment2")){window.CACHEMSG.push($.fn.cookie("default_comment2"))}else{window.CACHEMSG.push("<div class='c_head_img'><img src='./images/d3.jpg' class='c_head_img_img' /></div>这节目真好看")}if($.fn.cookie("default_comment3")){window.CACHEMSG.push($.fn.cookie("default_comment3"))}else{window.CACHEMSG.push("<div class='c_head_img'><img src='./images/d4.jpg' class='c_head_img_img' /></div>看预告片就好期待了")}if($.fn.cookie("default_comment4")){window.CACHEMSG.push($.fn.cookie("default_comment4"))}else{window.CACHEMSG.push("<div class='c_head_img'><img src='./images/d5.jpg' class='c_head_img_img' /></div>嗯嗯，我饿了")}};this.load_topic=function(){a.loadData({url:domain_url+"api/comments/topic/round",callbackCommentsTopicInfo:function(g){if(g.code==0){$(".c_topic").text(g.items[0].t);if(g.items[0].im){try{$("#commentPage").css({background:"url('"+g.items[0].im.split(",")[0]+"') no-repeat center center","background-size":"cover"})}catch(h){}}}}})};this.load_reserve();this.load_comment();this.load_activity();this.pushCommentMas();this.load_topic()};this.initPlugins=function(){this.showTip=function(d,c){var e=$("<div></div>");e.addClass("showTip").addClass("fadein");e.text(c);if(d){d.append(e);(function(f){setTimeout(function(){f.remove()},2000)})(e)}}};this.init=function(){b.ruleBtn();this.pageH();this.initParam();this.initEvent();this.initPlugins();this.loadData()};this.init()})});