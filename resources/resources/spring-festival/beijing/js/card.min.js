var stars=[{id:1,name:"王力宏",avatar:"./images/avatar/wlh.jpg",wish:"./audios/wlh.mp3",},{id:2,name:"TFboys",avatar:"./images/avatar/tfboy.jpg",wish:"./audios/tfboy.mp3",},{id:3,name:"华晨宇",avatar:"./images/avatar/hcy.jpg",wish:"./audios/hcy.mp3",},{id:4,name:"刘嘉玲",avatar:"./images/avatar/ljl.jpg",wish:"./audios/ljl.mp3",},{id:5,name:"萧敬腾",avatar:"./images/avatar/xjt.jpg",wish:"./audios/xjt.mp3",},{id:6,name:"张卫健",avatar:"./images/avatar/zwj.jpg",wish:"./audios/zwj.mp3",},{id:7,name:"姚晨",avatar:"./images/avatar/yc.jpg",wish:"./audios/yc.mp3",},{id:8,name:"吴亦凡",avatar:"./images/avatar/wyf.jpg",wish:"./audios/wyf.mp3",},{id:9,name:"徐静蕾",avatar:"./images/avatar/xjl.jpg",wish:"./audios/xjl.mp3",},{id:10,name:"黄磊",avatar:"./images/avatar/hl.jpg",wish:"./audios/hl.mp3",},{id:11,name:"黄渤",avatar:"./images/avatar/hb.jpg",wish:"./audios/hb.mp3",},{id:12,name:"蔡明",avatar:"./images/avatar/cm.jpg",wish:"./audios/cm.mp3",}];var wishes=["祝你新年快乐，合家幸福！","祝你大吉大利，顺风顺水！","祝你岁岁平安，事事如意！","祝你薪水翻番，好吃好穿！","祝你甜长苦短，常有新欢！","祝你吉星高照，财运亨通！","祝你官运亨通，美梦连连！","祝你和和美美，团团圆圆！","祝你顺心如意，大吉大利！","祝你平平安安，健健康康！"];(function(a){H.dialog={puid:0,$container:a("body"),REQUEST_CLS:"requesting",iscroll:null,init:function(){var b=this;this.$container.delegate(".btn-rule","click",function(c){c.preventDefault();H.dialog.rule.open()}).delegate(".btn-close","click",function(c){c.preventDefault();a(this).closest(".modal").addClass("none")}).delegate(".btn-result","click",function(c){c.preventDefault();H.dialog.result.open()}).delegate(".btn-lottery","click",function(c){c.preventDefault();H.dialog.lottery.open()}).delegate(".btn-comeon","click",function(c){c.preventDefault();H.dialog.guide.open()}).delegate(".btn-download","click",function(c){c.preventDefault();H.dialog.download.open()})},close:function(){a(".modal").addClass("none")},open:function(){H.dialog.close();if(this.$dialog){this.$dialog.removeClass("none")}else{this.$dialog=a(this.tpl());H.dialog.$container.append(this.$dialog)}H.dialog.relocate()},relocate:function(){var b=a(window).height(),c=a(window).width(),d=a(window).scrollTop()+b*0.06;a(".modal").each(function(){a(this).css({width:c,height:b}).find(".btn-close").css({right:c*0.06-15,top:d-15})});a(".dialog").each(function(){if(a(this).hasClass("relocated")){return}a(this).css({width:c*0.88,height:b*0.88,left:c*0.06,right:c*0.06,top:d,bottom:b*0.06});var e=a(this).find(".box");if(e.length>0){e.css("height",b*0.38)}})},guide:{$dialog:null,open:function(){H.dialog.open.call(this);this.event();var b=this;setTimeout(function(){b.close()},8000)},event:function(){var b=this;this.$dialog.find(".btn-try").click(function(c){c.preventDefault();window.localStorage.bjcwGuided=true;b.close()})},close:function(){this.$dialog&&this.$dialog.addClass("none")},tpl:function(){var b=simpleTpl();b._('<section class="modal modal-guide" id="guide-dialog">')._('<div class="dialog guide-dialog relocated">')._("<h2></h2>")._("<p><label>1.</label>打开电视收看北京电视台春晚</p>")._("<p><label>2.</label>打开微信进入“发现”打开“摇一摇”</p>")._("<p><label>3.</label>选择“电视”，对着电视摇一摇</p>")._("<h3>即有丰厚互动大奖等着您！</h3>")._('<a href="#" class="btn btn-try" data-collect="true" data-collect-flag="yg-guide-trybtn" data-collect-desc="引导弹层-关闭按钮">等下就去试试</a>')._("</div>")._("</section>");return b.toString()}},tips:{$dialog:null,open:function(){H.dialog.open.call(this);this.event()},event:function(){var b=this;this.$dialog.find(".btn-now").click(function(c){c.preventDefault();b.close()})},close:function(){this.$dialog&&this.$dialog.addClass("none")},tpl:function(){var b=simpleTpl();b._('<section class="modal modal-tips" id="tips-dialog">')._('<div class="dialog tips-dialog relocated">')._('<div class="content">摇得很辛苦吧，您小歇一会儿，和家人一起聊聊家常，看看北京春晚吧！</div>')._('<a href="#" class="btn btn-now">马上就去</a>')._("</div>")._("</section>");return b.toString()}},confirm:{$dialog:null,open:function(){H.dialog.open.call(this);this.event();a("#share").trigger("click")},event:function(){var b=this;this.$dialog.find(".btn-now").click(function(c){c.preventDefault();window.location.href="star.html"})},close:function(){this.$dialog&&this.$dialog.addClass("none")},tpl:function(){var b=simpleTpl();b._('<section class="modal modal-tips" id="confirm-dialog">')._('<div class="dialog tips-dialog confirm-dialog relocated">')._('<div class="content">您的贺卡已发送成功！</div>')._('<a href="#" class="btn btn-now">继续发贺卡</a>')._("</div>")._("</section>");return b.toString()}},didi:{$dialog:null,open:function(){H.dialog.open.call(this);this.event()},event:function(){var b=this;this.$dialog.find(".btn-tomobile").click(function(c){c.preventDefault();b.close();a("#mobile").focus()});this.$dialog.find(".btn-tocard").click(function(c){c.preventDefault();b.close();a("html").attr("class","h-star")})},close:function(){this.$dialog&&this.$dialog.addClass("none")},tpl:function(){var b=simpleTpl();b._('<section class="modal modal-tips" id="didi-dialog">')._('<div class="dialog tips-dialog didi-dialog relocated">')._('<div class="content">您的手机号码尚未填写，滴滴红包领取需提供手机号码，否则视为放弃</div>')._('<a href="#" class="btn btn-tomobile">去填手机号码</a>')._('<a href="#" class="btn btn-tocard">去发明星贺卡</a>')._("</div>")._("</section>");return b.toString()}},download:{$dialog:null,open:function(){H.dialog.open.call(this);this.event();a("body").addClass("noscroll")},event:function(){var b=this;this.$dialog.find(".btn-close").click(function(c){c.preventDefault();b.close()})},close:function(){a("body").removeClass("noscroll");this.$dialog.remove();this.$dialog=null},tpl:function(){var b=simpleTpl();b._('<section class="modal modal-download" id="download-dialog">')._('<a href="#" class="btn-close" data-collect="true" data-collect-flag="yg-ruledialog-closebtn" data-collect-desc="下载弹层-关闭按钮"></a>')._('<div class="dialog download-dialog">')._('<iframe src="http://pay.xiaojukeji.com/share/tmp_download.html?t='+(new Date().getTime())+'"></iframe>')._("</div>")._("</section>");return b.toString()}},rule:{$dialog:null,open:function(){H.dialog.open.call(this);this.event();var b=this;a("body").addClass("noscroll");getResult({url:"common/rule",jsonpCallback:"callbackRuleHandler",success:function(c){if(c.code==0&&c.rule){b.update(c.rule)}},error:function(){H.dialog.tips.open()}})},close:function(){a("body").removeClass("noscroll");this.$dialog&&this.$dialog.addClass("none")},event:function(){var b=this;this.$dialog.find(".btn-close").click(function(c){c.preventDefault();b.close()})},update:function(b){this.$dialog.find(".rule").html(b).removeClass("hidden")},tpl:function(){var b=simpleTpl();b._('<section class="modal" id="rule-dialog">')._('<a href="#" class="btn-close" data-collect="true" data-collect-flag="yg-ruledialog-closebtn" data-collect-desc="规则弹层-关闭按钮"></a>')._('<div class="dialog rule-dialog">')._("<h2></h2>")._('<div class="content border">')._('<div class="hidden rule"></div>')._("</div>")._('<p class="dialog-copyright">本活动最终解释权归“北京电视台”所有</p>')._("</div>")._("</section>");return b.toString()}}};W.callbackRuleHandler=function(b){if(b.code==0&&b.rule){H.dialog.rule.update(b.rule)}}})(Zepto);$(function(){H.dialog.init()});(function(){H.card={$star:$("#star"),starId:getQueryString("id"),SPEAKING_CLS:"h-speaking",LOADING_CLS:"loading",NORECORD_CLS:"norecord",STOPPING_CLS:"stopping",RECORDING_CLS:"recording",READY_CLS:"ready",starName:"",init:function(){if(!this.starId){window.location.href="star.html";return false}this.event();H.voice.init();var a=this;if(a.isView()){$("body").addClass("view-card");getResult({url:"ceremony/cardinfo",data:{cu:a.starId},loading:true,jsonpCallback:"callbackCardInfoHandler",success:function(b){if(b.result){a.fillData(b.sn,{name:b.nn,avatar:b.hi+"/"+yao_avatar_size,wish:b.gt,voice:b.vi});return}alert("贺卡信息加载失败")},error:function(){H.dialog.tips.open()}});if(window.localStorage&&!localStorage.bjcwGuided){H.dialog.guide.open()}}else{this.initWishes();a.fillData((parseInt(a.starId)||1),{name:$.fn.cookie(shaketv_appid+"_nickname"),avatar:$.fn.cookie(shaketv_appid+"_headimgurl")+"/"+yao_avatar_size})}wx.ready(function(){$("html").addClass(a.READY_CLS)})},isView:function(){return this.starId.length>2},initWishes:function(){var b=wishes||[],a=b.length;$("#input-bless").attr("placeholder",b[Math.floor(Math.random()*1000)%a])},fillData:function(a,f){var b=this.$star,d=$("#me"),e=W.stars[parseInt(a)-1];if(!e){return}$("#content").removeClass("hidden");b.find("img").attr("src",e.avatar||"");b.find(".voice").append('<audio preload="auto" class="audio none" src="'+e.wish+'"></audio>');b.find(".name").text(e.name||"");this.starName=e.name||"";d.find(".name").text(f.name);d.find("img").attr("src",f.avatar);if(f.voice){var c=d.find(".voice").addClass(H.card.LOADING_CLS).removeClass("none");wx.ready(function(){wx.downloadVoice({serverId:f.voice,success:function(g){H.voice.localId=g.localId;c.removeClass(H.card.LOADING_CLS)}})})}else{d.addClass("text").find(".wish-txt").removeClass("none").text(f.wish)}this.audioReady()},audioReady:function(){var a=this;$("audio").on("loadedmetadata",function(){$(this).siblings("span").text(Math.ceil($(this).get(0).duration)+"'");$(this).get(0).pause()})},event:function(){var i=this,g=$("#me"),k=$("#share"),h=$("#wrapper"),f=$("#btn-voice"),a=$("#btn-press"),j=$("#err-tip"),d="点击结束录音",c="点击开始录音",e="录音时间太短",b="正在停止录音";$("#btn-type").click(function(n){n.preventDefault();var m=$(this),l=$("html");if(!l.hasClass(i.READY_CLS)){alert("努力加载中，请稍候");return}if(l.hasClass(H.card.NORECORD_CLS)){return}$("#star-voice").find("audio").get(0).pause();a.text(c);l.addClass(H.card.SPEAKING_CLS)});a.click(function(m){m.preventDefault();var l=$("html");if(l.hasClass(H.card.RECORDING_CLS)){a.text(b).addClass(H.card.STOPPING_CLS);wx.stopRecord({success:function(n){H.voice.localId=n.localId;a.removeClass(H.card.STOPPING_CLS).text(c);l.removeClass(H.card.SPEAKING_CLS).removeClass(H.card.RECORDING_CLS);g.addClass("voice "+H.card.LOADING_CLS);wx.uploadVoice({localId:H.voice.localId,success:function(o){H.voice.serverId=o.serverId;g.removeClass(H.card.LOADING_CLS);$("#me-voice").trigger("click")}})},fail:function(){a.removeClass(H.card.STOPPING_CLS);l.removeClass(H.card.SPEAKING_CLS).removeClass(H.card.RECORDING_CLS)}})}else{l.addClass(H.card.RECORDING_CLS);$(this).text(d);wx.startRecord({cancel:function(){l.addClass(H.card.NORECORD_CLS).removeClass(H.card.SPEAKING_CLS);a.text(c)}})}});$("#star-voice").addClass("no-border").click(function(){var m=$(this),l=$(this).find("audio");if(m.hasClass("scale")){return}m.addClass("scale");l.get(0).play();l.on("playing",function(){console.log("playing")}).on("ended",function(){console.log("ended");l.get(0).pause();m.removeClass("scale")})});$("#me-voice").addClass("no-border").click(function(m){m.preventDefault();if(!H.voice.localId||$(this).hasClass("loading")){alert("正在加载祝福语音，请稍候");return}var l=$(this);l.addClass("scale");wx.playVoice({localId:H.voice.localId})});$("#btn-sendcard").click(function(n){n.preventDefault();var q=$("#input-bless"),l=H.voice.serverId,o=$.trim(q.val())||q.attr("placeholder"),m=o.length,p=g.hasClass("voice")?false:true;if((p&&m==0)||(!p&&!l)){alert("先说点什么吧");return}else{if(p&&m>300){alert("祝福的话儿贵精不贵多哦");return}}getResult({url:"ceremony/makecard",data:{oi:openid,sn:i.starId,gt:p?encodeURIComponent(o):"",vi:p?"":l,nn:encodeURIComponent($.fn.cookie(shaketv_appid+"_nickname")||""),hi:$.fn.cookie(shaketv_appid+"_headimgurl")||""},loading:true,bindUI:$(this),jsonpCallback:"callbackMakeCardHandler",success:function(r){if(r.result){W.cardid=r.cu;if(W.localStorage){W.localStorage.starName=i.starName}k.removeClass("none");$(window).scrollTop(0);return}alert("发送贺卡失败，请重试")},error:function(){H.dialog.tips.open()}})});k.click(function(){$(this).addClass("none")});$("#speak-dialog").addClass("no-border").click(function(m){m.preventDefault();var l=$("html");if(l.hasClass(H.card.RECORDING_CLS)||$(m.target).closest(".dialog").length>0){return}$("html").removeClass(H.card.SPEAKING_CLS)})}};H.voice={localId:"",serverId:"",init:function(a){$.ajax({type:"GET",url:domain_url+"mp/jsapiticket",data:{appId:shaketv_appid2,appSecret:shaketv_appsecret},async:true,dataType:"jsonp",jsonpCallback:"callbackJsapiTicketHandler",success:function(e){if(e.code!==0){return}var f="F7SxQmyXaFeHsFOT",d=new Date().getTime(),c=window.location.href.split("#")[0],b=hex_sha1("jsapi_ticket="+e.ticket+"&noncestr="+f+"&timestamp="+d+"&url="+c);wx.config({debug:false,appId:shaketv_appid2,timestamp:d,nonceStr:f,signature:b,jsApiList:["startRecord","stopRecord","onVoiceRecordEnd","onVoicePlayEnd","playVoice","pauseVoice","stopVoice","uploadVoice","downloadVoice"]});a&&a()},error:function(c,b){alert("获取微信授权失败！")}});wx.onVoiceRecordEnd({complete:function(b){H.voice.localId=b.localId;$("html").removeClass(H.card.SPEAKING_CLS)}});wx.onVoicePlayEnd({complete:function(b){$("#me-voice").removeClass("scale")}});wx.error(function(b){if(b.errMsg=="uploadVoice:fail"){alert("上传祝福语音到微信失败，请重试");$("#me").removeClass("loading voice")}})}}})(Zepto);$(function(){H.card.init()});