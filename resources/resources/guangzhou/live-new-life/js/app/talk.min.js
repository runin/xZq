$(function(){var a={showPage:function(b,d,e){var c=$(".page");c.addClass("none");c.each(function(g,h){var f=$(h);if(f.attr("id")==b){f.removeClass("none");a.currentPage=f;if(d){d(f)}return false}})},hashchange:(function(){$(window).bind("hashchange",function(){var b=window.location.hash.slice(1);if(b){a.page[b]()}else{b="firstPage";a.page[b]()}if(a[b].goIntoFn){a[b].goIntoFn()}});return{}})(),loadData:function(g){var f=$.extend({url:"",type:"get",async:false,dataType:"jsonp",showload:true},g);if(f.showload){W.showLoading()}var c=0;var e="";var b=null;for(var d in g){c++;if(c==2){e=d;b=g[d];break}}if(/test/.test(domain_url)){if(!g.data){g.data={}}g.data.dev="jiawei"}$.ajax({type:f.type,data:g.data,async:f.async,url:f.url,dataType:f.dataType,jsonpCallback:e,success:function(h){W.hideLoading();b(h)},error:function(){if(g.error){g.error()}W.hideLoading()}})},loadImg:function(c){if(!this.images){this.images=[]}if(c&&!(c instanceof Array)){c.isLoad=false;this.images.push(c)}else{if((c instanceof Array)){for(var e=0;e<c.length;e++){c[e].isLoad=false;this.images.push(c[e])}}}for(var d=0;d<this.images.length;d++){var f=this;if(!this.images[d].isLoad){var b=new Image();b.src=this.images[d].src;this.images[d].isLoad=true;b.onload=function(){}}}},showWin:function(c){var b=$.extend({html:"",beforeOpenFn:null,afterOpenFn:null},c||{});this.winObj=$('<div class="win"><div class="win_model"></div><div class="win_contain"><div class="win_html"></div></div></div>');this.close=function(d){this.winObj.remove();if(d){d()}if(this.closeFn){this.closeFn()}};this.setWidth=function(d){this.winObj.css("width",d)};this.setHeight=function(d){this.winObj.css("height",d)};this.setHtml=function(d){this.winObj.find(".win_html").append(d||b.html)};this.initEvent=function(){var d=this;this.winObj.find(".win_close").unbind("click").click(function(){d.close()})};this.init=function(d){this.setHtml();if(b.beforeOpenFn){b.beforeOpenFn(this.winObj)}$("body").append(this.winObj);this.initEvent();this.winObj.find(".win_contain").addClass("show_slow");if(b.afterOpenFn){b.afterOpenFn(this.winObj,this)}if(d){d()}}},module:function(d,c,b){!a[d]&&(a[d]=new c());if(b){$(function(){b()})}}};a.module("main",function(){this.initParam=function(){this.talk_say=$(".comment-list");this.send_btn=$("#send");this.send_input=$("#comments-info")};this.initEvent=function(){var d=this;d.uids=[];d.send_btn.click(function(f){if($("#comments-info").get(0).value==""){alert("请填写内容");return}a.loadData({url:domain_url+"api/comments/save",callbackCommentsSave:function(h){if(h.code==0){var g=h.uid;d.talk_item_t=d.talk_item.clone(true);if(nickname){d.talk_item_t.find(".user_name").text(nickname)}if(headimgurl){d.talk_item_t.find("#user_head").attr("src",headimgurl+"/64")}d.talk_item_t.find(".talk_content").text(d.send_input.val());d.talk_item_t.find(".user_uid").val(g);d.uids.push(g);d.talk_say.prepend(d.talk_item_t);d.send_input.val("")}else{if(h.message){alert(h.message)}else{alert("发表评论失败")}}},data:{co:encodeURIComponent(d.send_input.val()),op:openid,tid:getQueryString("uid"),ty:1,nickname:nickname?encodeURIComponent(nickname):"",headimgurl:headimgurl?headimgurl:""}});return false});var c=d.talk_say;var e=c.height();var b=2;c.scroll(function(h){var g=$(".talk_item").height();var f=c.get(0).scrollHeight;if((c.get(0).scrollTop+e+30)>=f){a.loadData({url:domain_url+"api/comments/list?temp="+new Date().getTime(),callbackCommentsList:function(i){if(i.code==0){b++;window.appendData(i.items,0)}else{}},error:function(){},data:{ps:10,page:b,anys:getQueryString("uid"),},showload:false})}})};this.loadComment=function(){var b=[];b.push("<li>");b.push('<img src="" id="user_head" alt="">');b.push('<div class="review-text">');b.push('<h3 class="user_name"></h3>');b.push('<p class="all-con" id="all-con"><span class="talk_content"></span></p>');b.push("</div>");b.push("</li>");var e=this;e.talk_item=$(b.join(""));e.maxid=0;e.talk_say.empty();window.appendData=function(g,k){for(var h=0,f=g.length;h<f;h++){var j=$(b.join(""));if(g[h].hu){j.find("#user_head").attr("src",g[h].hu+"/64")}else{if(g[h].im){j.find("#user_head").attr("src",g[h].im+"/64")}else{j.find("#user_head").attr("src","images/avatar.jpg")}}j.find(".user_name").html(g[h].na||"匿名");j.find(".talk_content").html(g[h].co);j.find(".user_uid").val(g[h].uid);if(e.uids.indexOf(g[h].uid)==-1){if(k==0){e.talk_say.append(j)}else{e.talk_say.prepend(j)}}}};var d=0;function c(){a.loadData({url:domain_url+"api/comments/room?temp="+new Date().getTime(),callbackCommentsRoom:function(f){if(f.code==0){e.maxid=f.maxid;e.items=f.items||[];appendData(e.items,d);d++;setTimeout(function(){c()},5000)}else{setTimeout(function(){c()},5000)}},error:function(){setTimeout(function(){c()},5000)},data:{ps:10,anys:getQueryString("uid"),maxid:e.maxid},showload:false})}c()};this.init=function(){this.initParam();this.initEvent();this.loadComment()};this.init()})});