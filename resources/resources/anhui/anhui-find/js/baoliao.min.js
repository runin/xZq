$(function(){var b=getQueryString("type")||1;var a=getQueryString("uid");init_page(b);getResult("user/"+openid+"/mobile",{},"callbackUserMobileHandler");getResult("findyou/peopleType",{},"callbackFindyouPeopleType");$("#btn-upload").click(function(c){c.preventDefault();if($(this).hasClass("none")){return}$("#input-file-upload").trigger("click")});$("#btn-submit").click(function(m){m.preventDefault();if($(this).hasClass("requesting")){return}$(this).addClass("requesting");var c=$("#content"),n=$.trim(c.val()),l=$("#phone"),o=$.trim(l.val()),s=$("#name"),d=$.trim(s.val()),t=$("#xun-name"),k=$.trim(t.val()),j=$("#xun-type"),f=$.trim(j.val()),p=$("#title"),r=$.trim(p.val()),q=/(^(0[0-9]{2,3}\-)?([2-9][0-9]{6,7})+(\-[0-9]{1,4})?$)|(^\d{11}$)/,g=$("#img-ctrl"),h="";if(b==1&&!r){$(this).removeClass("requesting");alert("请您输入标题");p.focus();return}if(b==2&&!f){$(this).removeClass("requesting");alert("请您选择寻人类型");j.focus();return}if(b==2&&!k){$(this).removeClass("requesting");alert("请您输入被寻人姓名");t.focus();return}if(b==2&&!d){$(this).removeClass("requesting");alert("请输入您的姓名");s.focus();return}if(!n){$(this).removeClass("requesting");alert("请您寻人线索");c.focus();return}var i=n.length;if(i<10||i>200){$(this).removeClass("requesting");alert("寻人线索长度为10-200字");c.focus();return}if(!o||!q.test(o)){$(this).removeClass("requesting");alert("请输入正确的电话号码，格式为：\n座机：010-12345678\n手机：13800138000");l.focus();return}g.find(".img-preview").each(function(){if($(this).hasClass("loading")){alert("图片上传中，请稍候...");return false}var e=$.trim($(this).attr("data-url"));h=e});if(b==1){getResult("findyou/clue/save",{uid:a,ti:encodeURIComponent(r),desc:encodeURIComponent(n),ph:o,img:h,yoi:openid},"callbackFindyouClue")}else{getResult("findyou/people/save",{ty:f,na:encodeURIComponent(k),desc:encodeURIComponent(n),ln:encodeURIComponent(d),ph:o,img:h,yoi:openid},"callbackFindyouPeople")}});$("#img-ctrl").on("click",".img-preview",function(c){c.preventDefault();if($(c.target).hasClass("close")){return}preview($(this).find("img").attr("src"))}).on("click",".close",function(c){c.preventDefault();$(this).closest("a").remove();$("#btn-upload").removeClass("none")});$(".btn-back-simple").click(function(g){g.preventDefault();var f=$.trim($("#content").val()),c=$.trim($("#phone").val()),d=$("#img-ctrl").find(".img-preview").length;if(f.length>0||c.length>0||d>0){if(!confirm("是否放弃提交新闻线索？")){return}else{window.location.href="../index.html"}return}window.location.href="../index.html"})});window.callbackUserMobileHandler=function(a){$("#phone").val(a.result)};window.callbackFindyouClue=function(a){$("#btn-submit").removeClass("requesting");if(a.code==0){window.is_submit=true;window.location.href="../baoliao_success.html"}};window.callbackFindyouPeople=function(a){$("#btn-submit").removeClass("requesting");if(a.code==0){window.is_submit=true;window.location.href="../baoliao_success.html"}};window.callbackFindyouPeopleType=function(c){if(c.code==0){var a=c.items;for(var b=0;b<a.length;b++){$("#xun-type").append('<option value="'+a[b].tid+'">'+a[b].tna+"</option>")}}};function init_page(a){if(a==1){$(".fa").addClass("none");$(".phone").attr("placeholder","联系电话")}else{$("#title").addClass("none")}}function fileSelected(){var e=document.getElementById("input-file-upload"),d=e.files.length,c="img-"+new Date().getTime();if($(".img-preview").length>=0){$("#btn-upload").addClass("none")}if(e.files&&e.files[0]){var a=new FileReader(),b=simpleTpl();b._('<a href="#" id="'+c+'" class="img-preview loading" data-collect="true" data-collect-flag="anhui-find-baoliao-preview-btn" data-collect-desc="爆料页面 预览图片按钮">')._('<span class="lc"><i class="uploading"></i></span>')._('<i class="close"  data-collect="true" data-collect-flag="anhui-find-baoliao-remove-img-btn" data-collect-desc="爆料页面 删除上传的图片按钮" data-stoppropagation="true"></i>')._('<span class="ic"><img src="http://yao.holdfun.cn/portal/resources/news/images/blank.gif" /></span>')._("</a>");$("#btn-upload").before(b.toString());a.onload=function(f){if(f.target.result){$("#"+c).find("img").attr("src",f.target.result);if((f.target.result).indexOf("image/")==-1){uploadimg(c,0,true)}}};a.readAsDataURL(e.files[0])}uploadFile(c)}function uploadFile(b){var a=new FormData();var c=document.getElementById("input-file-upload").files.length;if(c==0){return}a.append("file",document.getElementById("input-file-upload").files[0]);a.append("serviceName","clueImg");uploadimg(b,a)}var _flag=false;function uploadimg(c,b,a){_flag=a;var e=new XMLHttpRequest(),d=$("#"+c);e.addEventListener("load",function(f){if(f.target&&f.target.responseText){var g=null;try{g=$.parseJSON(f.target.responseText)}catch(h){}if(!g||g.code!=0){alert("上传图片失败");return}if(_flag){d.find("img").attr("src",g.filePath)}d.attr("data-url",g.filePath).removeClass("loading")}},false);if(b==0){return}e.addEventListener("error",function(){$("#"+c).removeClass("loading");alert("上传出错")},false);e.addEventListener("abort",function(){$("#"+c).removeClass("loading");alert("上传已取消")},false);e.open("POST",domain_url+"fileupload/image");e.send(b)}function preview(e){var c=simpleTpl(),a=$("#preview-box"),b=$(window).width(),d=$(window).height();if(a.length==0){c._('<div class="preview-box" id="preview-box">')._('<img class="none" src="http://yao.holdfun.cn/portal/resources/news/images/blank.gif" />')._("</div>");a=$(c.toString())}else{a.show()}imgReady(e,function(){var f=b-20,i=d-20,h=f/i,g=this.width/this.height;if(this.width>f||this.height>i){if(h<=g){i=f*(this.height/this.width)}else{f=i*(this.width/this.height)}}else{f=this.width;i=this.height}a.find("img").attr("src",e).css({width:f,height:i,"margin-left":(b-f)/2,"margin-top":(d-i)/2}).removeClass("none")});$("html").addClass("noscroll");$("body").append(a).delegate(".preview-box","click",function(f){a.hide();$("html").removeClass("noscroll")})};